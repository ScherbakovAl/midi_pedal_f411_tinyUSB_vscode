# CMSIS Intrinsics: __ISB, __DSB, __DMB, __REV, __NOP, __WFI, __WFE, __ROR

Описание функций из [`Drivers/CMSIS/Include/cmsis_gcc.h`](Drivers/CMSIS/Include/cmsis_gcc.h) для архитектуры ARM Cortex-M (STM32F411).

---

## Барьерные инструкции

### `__ISB()` — Instruction Synchronization Barrier
> Определение: [`cmsis_gcc.h:258`](Drivers/CMSIS/Include/cmsis_gcc.h)

```c
__ASM volatile ("isb 0xF":::"memory");
```

Сбрасывает конвейер процессора (pipeline flush). Все инструкции после `ISB` заново загружаются из кэша/памяти.

**Применение:**
- После изменения регистра `CONTROL` — именно поэтому `__set_CONTROL()` вызывает `__ISB()` сразу после записи
- После изменения таблицы векторов (VTOR)
- После включения/отключения кэша инструкций
- После самопрограммирования Flash

---

### `__DSB()` — Data Synchronization Barrier
> Определение: [`cmsis_gcc.h:269`](Drivers/CMSIS/Include/cmsis_gcc.h)

```c
__ASM volatile ("dsb 0xF":::"memory");
```

Ждёт завершения **всех** явных операций с памятью до этой инструкции. Процессор останавливается, пока все записи/чтения не завершатся физически.

**Применение:**
- Перед `__WFI()` — гарантирует завершение записей в периферию
- После записи в регистры NVIC
- После записи во Flash
- При работе с DMA перед передачей управления

---

### `__DMB()` — Data Memory Barrier
> Определение: [`cmsis_gcc.h:280`](Drivers/CMSIS/Include/cmsis_gcc.h)

```c
__ASM volatile ("dmb 0xF":::"memory");
```

Гарантирует **порядок** операций с памятью, но **не** ждёт их завершения. Операции до `DMB` будут видны другим наблюдателям (DMA) раньше операций после `DMB`.

**Разница с DSB:** `DSB` ждёт завершения, `DMB` только упорядочивает.

**Применение:**
- При передаче данных через разделяемую память между ядром и DMA
- При работе с буферами, которые читает DMA

```c
buffer[0] = data;
__DMB();           // DMA увидит запись до флага ready
ready_flag = 1;
```

---

## Инструкции управления питанием

### `__WFI()` — Wait For Interrupt
> Определение: [`cmsis_gcc.h:234`](Drivers/CMSIS/Include/cmsis_gcc.h)

```c
__ASM volatile ("wfi":::"memory");
```

Переводит процессор в режим **сна**. Выполнение приостанавливается до прихода любого прерывания (IRQ, NMI, SysTick).

**Применение:** главный цикл для экономии энергии, idle task в RTOS:

```c
while (1) {
    __DSB();
    __WFI(); // спать до следующего прерывания
}
```

---

### `__WFE()` — Wait For Event
> Определение: [`cmsis_gcc.h:242`](Drivers/CMSIS/Include/cmsis_gcc.h)

```c
__ASM volatile ("wfe":::"memory");
```

Похож на `WFI`, но пробуждается также от **события** (инструкция `SEV` — Send Event). Если флаг события уже установлен — немедленно продолжает и сбрасывает флаг.

**Применение:** синхронизация в многоядерных системах; более «мягкий» сон, пробуждается от большего числа источников.

---

## Утилитарные инструкции

### `__NOP()` — No Operation
> Определение: [`cmsis_gcc.h:228`](Drivers/CMSIS/Include/cmsis_gcc.h)

```c
__ASM volatile ("nop")
```

Пустая инструкция — ничего не делает, занимает один такт.

**Применение:**
- Небольшие паузы при работе с медленной периферией
- Выравнивание кода по границе памяти
- Предотвращение оптимизации компилятором критических участков

```c
GPIO_SetBits(GPIOA, GPIO_Pin_0);
__NOP(); __NOP(); // дать сигналу устояться
uint8_t val = GPIO_ReadInputDataBit(GPIOA, GPIO_Pin_1);
```

---

### `__REV(uint32_t value)` — Reverse Byte Order (32 bit)
> Определение: [`cmsis_gcc.h:292`](Drivers/CMSIS/Include/cmsis_gcc.h)

```c
return __builtin_bswap32(value);
// 0x12345678 → 0x78563412
```

Меняет порядок байт в 32-битном слове (Big-Endian ↔ Little-Endian).

**Применение:**
- Конвертация между сетевым (Big-Endian) и ARM (Little-Endian) порядком байт
- При работе с USB, MIDI, сетевыми протоколами, где данные передаются в Big-Endian

```c
uint32_t midi_word = receive_from_usb();
uint32_t host_word = __REV(midi_word); // перевести из сетевого порядка
```

---

### `__ROR(uint32_t op1, uint32_t op2)` — Rotate Right
> Определение: [`cmsis_gcc.h:346`](Drivers/CMSIS/Include/cmsis_gcc.h)

```c
return (op1 >> op2) | (op1 << (32U - op2));
```

Циклический сдвиг вправо на `op2` бит. Биты, «выпавшие» справа, появляются слева.

**Применение:**
- Алгоритмы хэширования (CRC, SHA)
- Криптография
- Манипуляции с битовыми полями в регистрах периферии
- Используется внутри CMSIS в `__SXTB16_RORn()` и `__SXTAB16_RORn()`

```c
uint32_t val = 0x00000001;
val = __ROR(val, 1); // → 0x80000000
val = __ROR(val, 1); // → 0x40000000
```

---

## Сводная таблица

| Функция | Инструкция ARM | Категория | Основное применение |
|---------|---------------|-----------|---------------------|
| `__ISB()` | `isb` | Барьер | Сброс конвейера после изменения системных регистров |
| `__DSB()` | `dsb` | Барьер | Ожидание завершения всех операций с памятью |
| `__DMB()` | `dmb` | Барьер | Упорядочивание операций с памятью (для DMA) |
| `__WFI()` | `wfi` | Питание | Сон до прерывания |
| `__WFE()` | `wfe` | Питание | Сон до прерывания или события |
| `__NOP()` | `nop` | Утилита | Пустой такт, задержка, выравнивание |
| `__REV()` | `rev` | Данные | Смена порядка байт (endianness) |
| `__ROR()` | — (C) | Данные | Циклический сдвиг вправо |

Все функции определены в [`Drivers/CMSIS/Include/cmsis_gcc.h`](Drivers/CMSIS/Include/cmsis_gcc.h) и являются частью стандарта CMSIS (Cortex Microcontroller Software Interface Standard), что обеспечивает переносимость кода между разными ARM Cortex-M микроконтроллерами.
